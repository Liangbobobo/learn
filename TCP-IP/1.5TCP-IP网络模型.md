# TCP/IP 网络模型  
TCP/IP架构在OSI网络参考模型之前很久已经被设计出来了，因此TCP/IP模型与OSI网络参考模型存在不同，大体上将两个模型的传输层对应的很好，OSI中的网络层和tcp/ip中的互联网层也对应的很好。   
网络访问层、互联网层、传输层、应用层四层模型。  

## tcp/ip网络访问层  network access layer
任务和功能：  
Ⅰ、该层是lan局域网技术（如以太网、令牌环网、无线介质和设备）发挥作用的分层   
Ⅱ、也是wan广域网技术和连接管理协议（如点对点协议point-to-point，ppp）发挥作用的分层。   

与OSI网络参考模型中使用的PDU术语不同，在这一层的PDU通常称为数据包packet或数据包datagram。

在network access layer 中应用的是电气工程师学会IEEE，institute of electrical and electronics engineers，的网络标准，包括IEEE 802系列标准。
2. 802.2 logical link control 802.2逻辑链路控制：给出了同一个物理网络上两个设备之间如何建立和管理逻辑链路的一般描述  
3. 802.2 media access control 802.2 媒体访问控制：给出了网络上媒体接口是如何标识和访问的一般描述，包括创建所有媒体接口唯一mac层地址的模式   
4. 802.3 CSMA/CD carrier sense multiple access with collision detection，带冲突检测的载波侦听多路访问：描述了以太网Ethernet的组网技术如何操作和访问。除了10Mb/s,和100Mb/s之外，这个系列还包括了千兆以太网gigabit Ethernet802.3z，但802.12的名称为高速网络。     
5. 802.5 token-ring令牌环：给出了由IBM开发的、成为令牌环网的组网技术如何操作和运行的一般描述。   
6. 802.11 wi-fi wireless fidelity（无线保真）的缩写：一个无线数据包的无线网络标准系列，支持1-540Mb/s（最大理论速度）的网络速度。这个系列中最常用的成员包括：11Mb/s的802.11a、802.11b标准，54Mb/s的802.11g标准，以及802.11n的多通道技术，其理论最大宽带是540Mb/s

# Tcp/ip网络访问层协议
最重要的网络访问层协议是ppp point to point protocol，用于在两个网络设备之间创建一个直接的连接。ppp可以提供连接认证以识别双方的身份，应用加密技术进行传输以实现保密，应用压缩技术以减少传输的数据量（在接收端都必须进行解码和解压缩）。ppp一个常见的变种为pppoe，是以太网上的ppp，ppp over Ethernet，广泛应用在以太网或者具备类似以太网特性的网络上，如catv网络的以太网信道，它使用的是电缆调制解调器技术

ppp广泛用于internet和专用tcp/ip网络连接，ppp是协议无关的，可以用于在一条串行线路连接上同时承载一组协议，如调制解调、T-载波链接、或其他类似的连接。   
Windows系统实现了ppp支持所有主要的Windows协议，tcp/ip、互联网分组交换/顺序分组交换（Internet pocket exchange/
sequenced packet exchange，ipx/spx）以及NetBIOS增强型用户接口（NetBIOS enhanced user interface，NetBEUI），同时也支持隧道协议，如点对点隧道协议point-to-point tunneling protocol，PPTP，以及其他虚拟专用网virtual private network VPN协议，在单个连接中传输。   
其他实现增加了对其他大量协议的支持，包括appletalk和系统网络体系结构（system networke architecture，sna）。  ppp是用于终端用户选择的串行线路协议，而绝大多数路由器和网络连接使用HDLC，原因在与他具有更低的过载能力。   
对终端用户来说ppp工作良好，支持各种安全选项，包括登录信息加密、在整个串行线路中所有数据流的加密，以及丰富的协议和服务。    

## PPP 的详细描述 RFC1661

下述网络访问（osi第二层）协议尽管不是tcp/ip协议族的一部分，但现在更可能遇到：
1. 高速数据链路控制，high-level data link control hdlc：基于IBM独创的sna数据链路控制（sna data link control，sdlc）协议。hdlc使用数据帧管理网络链接和数据传输。   
2. 帧中继，frame relay：一种电信通信服务，设计用于支持局域网与广域网端点之间的间歇式数据传输。帧中继使用数据帧管理网络链路和数据传输。   
3. 异步传输模式，asynchronous transfer mode ATM：一种高速的、面向信元的连接交换技术，广泛用于数字语音和数据通信，电信通信、数据网络主干和基础设施。




# tcp/ip互联网层的功能
tcp/ip的互联网层协议处理跨越多个网络的机器之间的路由问题，也管理网络名称和地址，以利于解决路由问题，即互联网层处理从发送方到接收方的数据移动。具体的说互联网层处理tcp/ip的如下三个任务：   
1. MTU分片：当路由将数据从一种类型的网络运送到另一种类型的网络时，网络能够承载的最大数据块mtu可能发生变化；当数据从支持较大mtu介质移动到支持较小mtu的介质时，这一数据必须被缩小。这个任务仅需要一次单向转换（由于当较小数据包传输到容许较大数据包的网络上时，这些数据包并不需要组合成较大的数据包），但它必须在数据传输过程中完成。  
2. 寻址：寻址定义了一种机制，即Tcp/ip网络中的所有网卡都必须与标识每一个网卡的专用、唯一的比特位模式相对应，这个比特位模式也标识了网卡所属的网络，或者是本地网络。  
3. 路由：路由定义了将数据包从发送方转发给接收方的机制，在从发送方到接收方的转发过程中，可能需要数个中间中继过程。这一功能不仅包含在成功传递的过程中，而且提供了跟踪传递性能的方法，以及在发生传递失效时报告错误的方法，否则就会发生障碍。
## 互联网层的协议
主要协议如下：
1. 网际协议，Internet Protocol IP：该协议负责把数据包从发送方路由到接收方。   
2. Internet 控制消息协议，Internet control message protocol，ICMP：该协议处理基于IP路由和网络行为的消息，特别是数据流状况和出错相关的消息。   
3. 地址解析协议，address resolution protocol，ARP：该协议在特定电缆网段上将数字IP网络地址转换为MAC地址，该协议总是应用在数据包传递的最后阶段。   
4. 反向地址协议，reverse address resolution protocol ，RARP：该协议将MAC地址转换为数字IP地址。尽管ARP和RARP是连接第二、第三层之间的桥梁，但因为他们都要操作ip和mac，习惯上把他们看作是第二层的协议，或许也因为大多数的协议栈的实现都在数据链路层代码模块中包含了这些功能。  
5. 自举协议，bootstrap protocol，Bootp：该协议是DHCP，dynamic host configuration protocol的前导协议，DHCP管理网络IP地址分配和其他IP配置数据。BOOTP支持网络设备从网络上获取启动和配置数据，而不是从本地硬盘上获取这些数据。由于DHCP和BOOTP的数据首部大部分相同，因此绝大多数分析器会将DHCP和BOOTP的数据包报告为BOOTP类型的数据包。   
6. 路由信息协议，routing information protocol，RIP：该协议定义了原始距离向量（距离向量本质上是链路中路由器个数的整数计数，成为跳数，hop，RIPv1有一个4位的跳数字段，因此允许最大的跳数为15，该协议还有RIPv2和RIPv6两个版本）和本地网内用于本地路由区域的最基本路由协议。   
7. 开放式最短路径优先协议，open shortest path first：该协议定义了一个本地网内用于本地或内部路由区域的、广泛使用的链路状态路由协议。   
8. 边界网关协议，border gateway protocol，BGP：该协议定义了一种连接到公共互联网主干网或互联网中其他路由区域（这些区域中多方联合负责管理数据流）的广泛应用路由协议。

# Tcp/ip传输层的功能
通常把运行在Internet上的设备标识为主机host，因此tcp/ip传输层有时候也称为主机到主机层，这一层提供了从一台主机到另一台主机的数据移动。   
基本功能：  
1. 从发送方到接收方的数据可靠传输  
2. 传输前必要的出站消息分段  
3. 数据交付给应用层之前重组分段以便进一步处理

## Tcp/ip传输层协议
1. 传输控制协议TCP  
面向连接的connection-oriented
2. 用户数据报协议UDP
connectionless  
两者的区别：TCP在发送数据之前在发送方和接收方之间协商并维持连接，数据成功发送得到正确确认，数据丢失或者错误得到重传请求。    
UDP以一种最大努力交付best-effort delivery的方式简单的发送数据，在接受方没有任何的后续校验，这使得TCP比UDP更加可靠，但速度更慢更笨拙一些。

## Tcp/IP应用层
是协议栈与主机上的应用程序或进程交互的地方，又称为处理层process layer。   
在这里定义了与进程或应用程序交互的用户接口，因此在这里出现了Tcp/ip协议与服务之间的重叠。如FTP    
还定义了关于文件传输、终端传真等服务  


基于TCP的服务：   
基于UDP的服务：网络文件系统，network file system，NFS；IP语音，voice over IP，VoIP；各种形式的流媒体包括H.323协议支持的流媒体。   
但，无论使用哪种传输方式，高级服务都与其网络协议中的IP有关，这也是在网络层、互联网层提供单独协议（ICMP、ARP、RARP）以提供专用网络服务的原因。   

TCP/IP服务的运行依赖如下两个要素：   
1. 守护程序：在Unix系统中，守护程序daemon是一种特殊的侦听进程，运行在服务器上，用于处理特定服务的入站用户请求。在Windows server 2008中，只要web服务器、IIS、FTP服务器在运行中，任务管理器的进程中会有一个INETINFO.EXE的进程，在Unix主机上，FTP服务与ftpd的进程相对应，Internet服务运行在inetd的进程中。  
2. 端口地址：TCP/IP服务有一个相应的端口地址，也称为端口号，使用16位数值表示，用于识别特定的服务和进程。在范围0-1024之间的端口通常是公认/公共端口地址well-known port address，将特定的端口地址与特定的服务关联起来。如FTP-21

任何守护程序或侦听程序本质上都是在运行中等待，侦听与其服务相对应的公认端口地址上的连接企图。公认端口地址经常可以作为配置选项进行修改，如www.baidu.com:8080,指明使用8080端口，而不是默认的80端口建立连接。

当一个连接请求到达时，侦听进程检验是否允许处理该请求，如果是，侦听进程创建一个临时进程（Unix），或生成一个独立的执行线程（Windows server 2008）来处理这个特殊请求。   
这种临时进程或执行线程仅仅持续到服务足以处理用户请求的时刻为止，并使用范围1024-65535的临时端口地址处理用户请求（有时服务会使用4个端口地址，以便双方能同时管理不同的连接，如使用不同的连接可以实现数据传输和控制信息的分离）一旦处理某一个特定请求的进程或线程创建完毕，侦听进程或守护程序就返回到为该服务侦听其他请求的工作状态。

## Tcp/ip协议、服务、套接字、端口
在Tcp/ip环境中，要求有一种机制把多个应用区分开来，在数据被传递给IP用于寻址和传送前，传输协议（TCP、UDP）处理来自多个不同程序的多个出站数据流。入站数据要求完成相反过程。传输层PDU的入站数据必须被检验和分离，并把结果消息交付给适宜的请求应用程序。   
将各种不同来源的出站数据合并成一个单一数据流的过程称为多路复用multiplexing；   
拆分入站数据流、以便把分离的部分交付给正确应用程序的过程称为多路分解demultiplexing；  
这一动作在传输层处理，在这里，出站消息也被拆分成适合他们所传输网络要求大小的数据块，入站消息从入站数据流中依照正确顺序被重组。  
为了使上述工作更加容易，Tcp/ip使用协议号protocol number来标识不同的协议，这些协议使用端口号port number来标识特定的应用层协议和服务。   
许多端口号被保留用于标识公共协议well-known protocol。公认协议分配了一系列编号，用于标识大量基于Tcp/ip的服务，例如文件传输FTP、终端仿真Telnet、电子邮件SMTP，simple mail transfer protocol简单邮件传输协议、IMAP，Internet message access protocol因特网消息访问协议、POP3，post office protocol version3，邮局协议版本3  

公认协议号、预分配协议号以及端口号在assigned number RFC文档中描述   
UNIX机器在两个文本文件中定义了这些值：协议号定义在/etc/protocols中，端口号定义在/etc/services中

### Tcp/ip协议号
在IP数据包的首部中，协议号出现在第10个字节中

### Tcp/ip 端口号 和套接字
在IP将入站数据传递给位于传输层的TCP或UDP后，这些协议必须履行其职责，将数据传递给预定的应用进程，无论程序正在运行什么都应该依据用户的操作接收数据。   
TCP/IP应用进程有时候也被称为网络服务（network service），并由端口号来标识。   
源端口号source port number标识发送数据的进程，目标端口号destination port number标识接收数据的进程。  
这些值都使用两个字节16位表示，放在每一个tcp数据段或udp数据包的第一个首部字中，由于端口号是16位的值，用十进制表示时他们的取值范围在0-65535之间。   
小于256的端口号被保留用于公认服务，256-1024的端口号保留用于Unix的专用服务，现在小于1024的端口号都用于表示公认服务。还有被称为注册端口号registered port的，他们与特定的服务相关联，数值为1024-65535。   
公认端口号或注册端口号代表了与特定网络服务特殊关联的预先分配端口号，由于发送方和接收方都一致同意特定服务与特定端口地址相关联，这种做法简化了客户/服务器的连接过程。   
除此之外，还有另一种的端口号称为动态分配的端口号，这些端口号不是预先分配的，而是需要时为发送方和接收方之间提供有限数据交换的临时连接，这种做法允许每一个系统维持大量的打开连接，并为每一个连接分配它自己唯一的、动态分配的端口地址，这些端口号的范围在1024以上，此范围内任何当前未用的地址都可以成为这种临时用途的端口号。

在客户或服务器使用公认端口号建立通信之后，所建立的连接（称为会话）持久的交付给一对临时套接字地址，它提供了发送方与接收方之间进一步通信所用的发送和接收端口号。   

特定IP地址（进程正在运行的机器上的）与动态分配端口号（维持连接所需的）的组合称为套接字地址（socket address），简称套接字socket。由于IP地址和动态分配的端口号都保证了他们的唯一性，因此每一个套接字地址也保证在整个Internet是唯一的。

## 1.7 TCP/IP中的数据封装
TCP/IP协议栈的每一层，出站数据都被封装和标识，以便交付给下一层，入站数据在交付给上层协议之前，低层协议拆分信息。   
这样，每一个PDU在开头都已自己一个特殊的部分，称为首部header或数据包首部packet header，标识了所用协议、发送方与预计的接收方，以及其他信息。   
PDU在结尾也都包含了一个特殊部分，称为尾部trailer或数据包尾部packet trailer，它提供了对PDU中数据部分的数据完整性检查信息。   
数据部分也被称为有效载荷payload。   
对位于首部和（可选）尾部之间的有效载荷进行打包就定义了称为封装encapsulated的机制，从上一层获取数据后，在传递给下一层，或通过网络介质交付到其他地方之前，使用首部和可能的尾部对数据封装。
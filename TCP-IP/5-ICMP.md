# Internet 控制消息协议 Internet Control Message Protocol ICMP，运行在网络层
内容：是一个错误处理和消息处理协议，是Tcp/Ip协议族不可或缺的一部分，是IP的核心协议。             
作用：提供了有关网络可连接性和路由行为的信息，这些事基于数据报的、无连接协议（IP和UDP）无法传输的。   
ICMP消息用来让主机报告网络状况和问题，也可使主机能够选择网络上的最佳路径。（当数据报不能到达预定接收方时，会有一条ICMP消息告知发送方。当网关或路由器能够把主机引导到一条更好的网络路由上时，将发送一条重定向消息）    
提供有关IP路由行为、可达性、两个特定主机之间的路由、传输错误等各种信息   
运行在网络层   
## 5.1
Reachability可达性：对于任何网络节点，如果要与另一个网络节点进行通信和数据交换，一定存在从发送方到接收方转发数据的某种方法，这一概念称为可达性     
正常情况下，在位于发送发与接收方之间的各种中间设备的本地IP路由表中，可以找到可用的转发路径。   

ICMP如何工作：   
ICMP利用特殊类型的消息，提供了一种将信息返回给发送发的方法，这些信息是关于数据包在转发过程中所经历的路由，包括可达性信息。     
ICMP还提供了一种在因为路由或可达性问题而阻止了IP数据报交付时返回错误信息的方法。   
IP数据报：TCP/IP协议定义了一个在因特网上传输的包，称为IP数据报。IP数据报就是IP协议传输的数据，IP数据报包含地址、路由选择信息和其它为将数据的分组从源地发送到目的地的分组头信息。 这是一个与硬件无关的虚拟包，由首部和数据两部分组成。   

这种能力很好的补充了IP的数据包交付服务，因为ICMP提供了IP自身不能提供同的东西，路由、可达性、控制信息以及交付错误报告。
事实上，ICMP消息不过是特殊格式的IP数据报，它有一个8字节的首部，与一般网络流量中其他IP数据报受到相同的限制。      
### ICMP在网络中的作用
如前所述，ICMP的任务是提供有关IP路由行为、可达性、两个特定主机之间的路由、传输错误等各种信息的。  
ICMP提供的信息对网络监控和故障诊断相当有用。

## 5.2 ICMPv4
ICMP是IP的核心协议，计算机操作系统使用ICMPv4，主要用于发送某些错误消息给其他网络节点。      
尽管ICMPv4被认为是一种传输协议，但是它与TCP和UDP不同，并不携带有效载荷，不能被计算机应用程序使用，其支持一系列的网络测试和错误消息。    
ping    
tracert、traceroute，可跟踪从源计算机到达目的地计算机之间的IP数据包，计算数据包在传输过程中经过跳数，以及每跳所需的时间。     
ICMP消息类型：Echo请求、Echo应答、目的地不可达、路由器公告等。
## 5.21 RFC 792

## 5.22 ICMPv4的首部
IP首部协议字段的值1表示ICMP首部紧跟在该IP首部后面。    
ICMP首部由两部分组成：固定部分和可变部分。    
固定部分：   
IP首部后面，ICMP数据包仅包含3个必须字段：类型字段Type、编码字段Code、校验和字段Checksum。    
单，在某些ICMP数据包中，还有一些附加字段，他们提供了消息的信息或细节，或提供了某些特定消息的信息。如：ICMP重定向数据包需要包含用于数据报重定向的网关地址，一旦接收到这样的数据包，主机应该在其路由表中添加一个动态路由项，并立即开始使用新的路由信息。    

校验和字段：仅用于ICMP首部的错误检测，跟在校验和后面的字段依据所发送的特定ICMP消息而变化。    

## 5.23 ICMPv4消息的类型
ICMP的消息类型分为，错误消息和信息消息。    
所有ICMPv4消息都使用一种常用消息格式，并使用一组协议规则来发送和接收，但其消息的详细内容因特定的消息类型而不同。    
路由器和网络结点使用ICMPV4错误消息来告知源结点，它所传输的数据报在网络上遇到了一个问题，影响了它的传输。ICMPV4消息类型往往会要求有来自发送结点的某种响应。   
如果往源结点发送一个消息，声明其数据报是无法交付的，发送方将希望发现是什么问题，并寻找一种解决方法。如下：  
### 目的地不可达消息
当发送的数据报不能传输给目的地址时，会给源结点返回目的地不可达消息（Destination Unreachable Message）。  
数据包传输失败，有时因为一些数据包含有错误参数，如不合法的IP地址；  
有时是因为，由于IPv4是不可靠协议，不能保证发送的数据包肯定能到达目的地，如果数据包不能到达目的地，那么目的地不可达消息将会与无法交付的部分数据报一起返回给发送节点。然后发送方就可以使用这些信息来决定如何改正问题。  
### 源节点抑制消息
作用：告诉源节点，降低往目的地节点发送数据报的速率。  
通常，当输入的数据流量快过处理能力时，网络结点可以把数据包缓存起来。但一个设备的缓冲区大小是有限的，当缓存区缓存满了时，而接收结点无法快速处理数据流以减少缓冲区的内容，就会发送一个源结点抑制消息给发送结点。  
通常，源结点会响应，降低传输速率，直到不再接收到源结点抑制为止。  
源结点抑制消息的作用是有限的，因为它们只含有目的地拥塞的信息，它们并不能告诉源结点，它该为出现的问题做些什么。同样，也不会给源结点发送消息，告诉它目的地的缓冲区现在不是满的，从而可以接收以更快速率发送的数据了，对该消息的响应完全留给源结点负责。   
更高层的TCP协议具有更高效的流控制机制，可用于调节两个网络设备之间的数据包传输。
### 超时消息
有两种情况会出现：  
一、在数据包到达其目的地之前，网络上的路由器吧数据包的生存时间TTL字段减少为0了。   
二、当结点的数据包重组计时器为0时，还有一些消息段没有到达目的地结点。 

### 重定向消息
当某个第一跳路由器接收到一个数据包，该数据包可以被另一个第一跳路由器更有效地管理时，就会往源网络结点发送一个重定向（redirect）消息。   
从技术上说，重定向消息并不是错误消息，但ICMPV4就是这样分类的（ICMPV6则是把该消息重新分类为信息消息）。   
重定向消息用于为结点提供数量有限的路由信息，路由器并不会给其他路由器发送重定向消息。

### 参数问题消息
是一种通用的错误消息，如果网络上的任何设备在IP数据包的首部字段中检测到了一个错误，这些设备就会发送回一个参数问题消息给源结点。  
初始的ICMP标准含有两种类型的消息：信息请求和信息应答，它们并不是ICMPV4实现的一部分，因为它们的功能目前是由其他协议如BOOTP、DHCP、RARP管理的。  
参数问题消息含有一个特殊的指针字段，用于告诉源结点，在数据包的首部中发生了哪种类型的问题。  
当网络上的一个设备发现数据包在其某个字段中含有错误参数，该结点将把数据包丢弃，并往源结点发送回参数问题消息。  
很多ICMPv4消息提供的消息与错误纠正没有任何关系，但现在这种类型的消息有9种，且大多数是成对出现的，如下：  
1. Echo请求和Echo应答消息  
作用：用于网络结点间的连通性测试，如ping。   
当Echo请求消息无法到达目的地结点时，接收Echo消息但无法把它转发的设备将发送错误消息。这种消息就是前面介绍的目的地不可达消息。  
2. 时间戳请求与时间戳应答消息   
在网络上，路由器使用这两个消息来同步化系统时钟的日期和时间。  
网络上的每个设备都有一个系统时钟，利用它，就可以知道日期和时间。但，两个设备不可能具有完全一致的时间，当这些设备一起工作时，就可能出现问题。当某个设备如果想与另一个设备同步化其系统时间，就可以发送一个时间戳请求消息给第二个设备，该设备响应一个时间戳应答消息。  
但，在大型网络中，尤其是Internet中，这种时间同步化的方法并不能很好的工作，因为这样来回传输ICMPV4消息很费时间，对于大型网络以及现代的网络基础设施来说，其中的设备使用的是网络时间协议（Network Time Protocol，NTP），在它们的系统时钟上创建完全一致的时间。NTP详见GitHub，http://nwtime.org/master-ntp-repositories-on-github/   
3. 路由器公告与路由器请求消息  
这两个消息允许网络结点不用手工配置第一跳路由器的地址，以请求和接收本地网络中的路由器信息。  
当网络结点第一次启动时，如果不了解网络中的任何路由器，就会使用给所有路由器的多播地址224.0.0.2发送一个ICMPv4路由器请求信息，使得只有路由器才会接收该请求，避免与网络上的所有设备发生通信，路由器使用有关自己的信息来响应该结点。  
路由器会定期使用所有设备的多播地址224.0.0.1来发送路由器公告地址，需要路由器信息或需要更新其路由器信息的结点，接收该公告并更新本地路由器信息。  
尽管利用路由器公告消息也可以了解本地路由器的信息，但通过路由器请求消息，可以使得计算机的在启动后要发现路由器地址时，无需等待和侦听这些路由器消息。  
实际上，这种路由器发现方法不是必需的，通常计算机使用DHCP动态的接收默认路由器的IP地址。  
重点：  
路由器公告消息并不是用于在路由器之间交换路由器信息的，也不会把复杂的路由表植入网络结点。网络结点只含有与本地网络中的计算机进行通信所需的信息，以及明白如何与路由器进行联系，以便与其他网络上的结点进行通信。路由器是使用路由协议（如RIP、OSPF）来与其他路由器交换路由信息的。  
4. 地址掩码请求与地址掩码应答  
作用：为发送地址掩码请求的结点提供关于网络中其他计算机的子网掩码信息。  
网络中的某个结点可能直到另一个结点的IP地址，但它并不知道如何解释该IP地址，除非摘掉了应用于该地址的子网掩码。   
发送地址掩码请求消息的结点，通常使用单播或广播来把消息发送给路由器，路由器使用应答消息来响应该结点，告诉该结点本地网络所使用的子网掩码（该结点中的子网掩码也与本地网络中每台计算机的子网掩码相同）  
与路由器公告和路由器请求消息不同，路由器并不会有规律的公告子网信息，它们只有在响应网络结点的一个请求时，才会发送子网掩码信息。   
地址子网掩码请求和地址掩码应答消息也不是必须的，大多数计算机是通过DHCP来获得子网掩码信息的。  
5. Traceroute消息  
类似与Echo请求和Echo应答消息，但它并不是只用于测试基本的网络连通性。  
这种ICMPv4消息可跟踪数据包所经过的一系列路由器，通过这些路由器，逐跳地把数据包从源结点发送到目的地结点。  
在Windows系统中，这些消息是利用Tracert实用工具来发送的，在Linux中，使用的是Traceroute程序。虽然名称不同，但是但其底层的ICMPv4消息格式是相同的，一个Traceroute消息是作为单个数据包来发送的，它包含有一个特定的Traceroute IP选项，通过对这个选项的辨识，路由器把该数据包接收为一个测试消息。路由器沿路由路径把该数据包转发到目的地结点，每个转发了该消息的路由器，都会用一个Traceroute消息来应答源结点，这个Traceroute消息含有该路由器的IP地址和（或）名称，以及经过该路由器所需的时间（以毫秒为单位）。   
# Internet 控制消息协议 Internet Control Message Protocol ICMP，运行在网络层
内容：是一个错误处理和消息处理协议，是Tcp/Ip协议族不可或缺的一部分，是IP的核心协议。             
作用：提供了有关网络可连接性和路由行为的信息，这些事基于数据报的、无连接协议（IP和UDP）无法传输的。   
ICMP消息用来让主机报告网络状况和问题，也可使主机能够选择网络上的最佳路径。（当数据报不能到达预定接收方时，会有一条ICMP消息告知发送方。当网关或路由器能够把主机引导到一条更好的网络路由上时，将发送一条重定向消息）    
提供有关IP路由行为、可达性、两个特定主机之间的路由、传输错误等各种信息   
运行在网络层   
## 5.1
Reachability可达性：对于任何网络节点，如果要与另一个网络节点进行通信和数据交换，一定存在从发送方到接收方转发数据的某种方法，这一概念称为可达性     
正常情况下，在位于发送发与接收方之间的各种中间设备的本地IP路由表中，可以找到可用的转发路径。   

ICMP如何工作：   
ICMP利用特殊类型的消息，提供了一种将信息返回给发送发的方法，这些信息是关于数据包在转发过程中所经历的路由，包括可达性信息。     
ICMP还提供了一种在因为路由或可达性问题而阻止了IP数据报交付时返回错误信息的方法。   
IP数据报：TCP/IP协议定义了一个在因特网上传输的包，称为IP数据报。IP数据报就是IP协议传输的数据，IP数据报包含地址、路由选择信息和其它为将数据的分组从源地发送到目的地的分组头信息。 这是一个与硬件无关的虚拟包，由首部和数据两部分组成。   

这种能力很好的补充了IP的数据包交付服务，因为ICMP提供了IP自身不能提供同的东西，路由、可达性、控制信息以及交付错误报告。
事实上，ICMP消息不过是特殊格式的IP数据报，它有一个8字节的首部，与一般网络流量中其他IP数据报受到相同的限制。      
### ICMP在网络中的作用
如前所述，ICMP的任务是提供有关IP路由行为、可达性、两个特定主机之间的路由、传输错误等各种信息的。  
ICMP提供的信息对网络监控和故障诊断相当有用。

## 5.2 ICMPv4
ICMP是IP的核心协议，计算机操作系统使用ICMPv4，主要用于发送某些错误消息给其他网络节点。      
尽管ICMPv4被认为是一种传输协议，但是它与TCP和UDP不同，并不携带有效载荷，不能被计算机应用程序使用，其支持一系列的网络测试和错误消息。    
ping    
tracert、traceroute，可跟踪从源计算机到达目的地计算机之间的IP数据包，计算数据包在传输过程中经过跳数，以及每跳所需的时间。     
ICMP消息类型：Echo请求、Echo应答、目的地不可达、路由器公告等。
## 5.21 RFC 792

## 5.22 ICMPv4的首部
IP首部协议字段的值1表示ICMP首部紧跟在该IP首部后面。    
ICMP首部由两部分组成：固定部分和可变部分。    
固定部分：   
IP首部后面，ICMP数据包仅包含3个必须字段：类型字段Type、编码字段Code、校验和字段Checksum。    
单，在某些ICMP数据包中，还有一些附加字段，他们提供了消息的信息或细节，或提供了某些特定消息的信息。如：ICMP重定向数据包需要包含用于数据报重定向的网关地址，一旦接收到这样的数据包，主机应该在其路由表中添加一个动态路由项，并立即开始使用新的路由信息。    

校验和字段：仅用于ICMP首部的错误检测，跟在校验和后面的字段依据所发送的特定ICMP消息而变化。    

## 5.23 ICMPv4消息的类型
ICMP的消息类型分为，错误消息和信息消息。    
所有ICMPv4消息都使用一种常用消息格式，并使用一组协议规则来发送和接收，但其消息的详细内容因特定的消息类型而不同。    
路由器和网络结点使用ICMPV4错误消息来告知源结点，它所传输的数据报在网络上遇到了一个问题，影响了它的传输。ICMPV4消息类型往往会要求有来自发送结点的某种响应。   
如果往源结点发送一个消息，声明其数据报是无法交付的，发送方将希望发现是什么问题，并寻找一种解决方法。如下：  
### 目的地不可达消息
当发送的数据报不能传输给目的地址时，会给源结点返回目的地不可达消息（Destination Unreachable Message）。  
数据包传输失败，有时因为一些数据包含有错误参数，如不合法的IP地址；  
有时是因为，由于IPv4是不可靠协议，不能保证发送的数据包肯定能到达目的地，如果数据包不能到达目的地，那么目的地不可达消息将会与无法交付的部分数据报一起返回给发送节点。然后发送方就可以使用这些信息来决定如何改正问题。  
### 源节点抑制消息
作用：告诉源节点，降低往目的地节点发送数据报的速率。  
通常，当输入的数据流量快过处理能力时，网络结点可以把数据包缓存起来。但一个设备的缓冲区大小是有限的，当缓存区缓存满了时，而接收结点无法快速处理数据流以减少缓冲区的内容，就会发送一个源结点抑制消息给发送结点。  
通常，源结点会响应，降低传输速率，直到不再接收到源结点抑制为止。  
源结点抑制消息的作用是有限的，因为它们只含有目的地拥塞的信息，它们并不能告诉源结点，它该为出现的问题做些什么。同样，也不会给源结点发送消息，告诉它目的地的缓冲区现在不是满的，从而可以接收以更快速率发送的数据了，对该消息的响应完全留给源结点负责。   
更高层的TCP协议具有更高效的流控制机制，可用于调节两个网络设备之间的数据包传输。
### 超时消息
有两种情况会出现：  
一、在数据包到达其目的地之前，网络上的路由器吧数据包的生存时间TTL字段减少为0了。   
二、当结点的数据包重组计时器为0时，还有一些消息段没有到达目的地结点。 

### 重定向消息
当某个第一跳路由器接收到一个数据包，该数据包可以被另一个第一跳路由器更有效地管理时，就会往源网络结点发送一个重定向（redirect）消息。   
从技术上说，重定向消息并不是错误消息，但ICMPV4就是这样分类的（ICMPV6则是把该消息重新分类为信息消息）。   
重定向消息用于为结点提供数量有限的路由信息，路由器并不会给其他路由器发送重定向消息。

### 参数问题消息
是一种通用的错误消息，如果网络上的任何设备在IP数据包的首部字段中检测到了一个错误，这些设备就会发送回一个参数问题消息给源结点。  
初始的ICMP标准含有两种类型的消息：信息请求和信息应答，它们并不是ICMPV4实现的一部分，因为它们的功能目前是由其他协议如BOOTP、DHCP、RARP管理的。  
参数问题消息含有一个特殊的指针字段，用于告诉源结点，在数据包的首部中发生了哪种类型的问题。  
当网络上的一个设备发现数据包在其某个字段中含有错误参数，该结点将把数据包丢弃，并往源结点发送回参数问题消息。  
很多ICMPv4消息提供的消息与错误纠正没有任何关系，但现在这种类型的消息有9种，且大多数是成对出现的，如下：  
1. Echo请求和Echo应答消息  
作用：用于网络结点间的连通性测试，如ping。   
当Echo请求消息无法到达目的地结点时，接收Echo消息但无法把它转发的设备将发送错误消息。这种消息就是前面介绍的目的地不可达消息。  
2. 时间戳请求与时间戳应答消息   
在网络上，路由器使用这两个消息来同步化系统时钟的日期和时间。  
网络上的每个设备都有一个系统时钟，利用它，就可以知道日期和时间。但，两个设备不可能具有完全一致的时间，当这些设备一起工作时，就可能出现问题。当某个设备如果想与另一个设备同步化其系统时间，就可以发送一个时间戳请求消息给第二个设备，该设备响应一个时间戳应答消息。  
但，在大型网络中，尤其是Internet中，这种时间同步化的方法并不能很好的工作，因为这样来回传输ICMPV4消息很费时间，对于大型网络以及现代的网络基础设施来说，其中的设备使用的是网络时间协议（Network Time Protocol，NTP），在它们的系统时钟上创建完全一致的时间。NTP详见GitHub，http://nwtime.org/master-ntp-repositories-on-github/   
3. 路由器公告与路由器请求消息  
这两个消息允许网络结点不用手工配置第一跳路由器的地址，以请求和接收本地网络中的路由器信息。  
当网络结点第一次启动时，如果不了解网络中的任何路由器，就会使用给所有路由器的多播地址224.0.0.2发送一个ICMPv4路由器请求信息，使得只有路由器才会接收该请求，避免与网络上的所有设备发生通信，路由器使用有关自己的信息来响应该结点。  
路由器会定期使用所有设备的多播地址224.0.0.1来发送路由器公告地址，需要路由器信息或需要更新其路由器信息的结点，接收该公告并更新本地路由器信息。  
尽管利用路由器公告消息也可以了解本地路由器的信息，但通过路由器请求消息，可以使得计算机的在启动后要发现路由器地址时，无需等待和侦听这些路由器消息。  
实际上，这种路由器发现方法不是必需的，通常计算机使用DHCP动态的接收默认路由器的IP地址。  
重点：  
路由器公告消息并不是用于在路由器之间交换路由器信息的，也不会把复杂的路由表植入网络结点。网络结点只含有与本地网络中的计算机进行通信所需的信息，以及明白如何与路由器进行联系，以便与其他网络上的结点进行通信。路由器是使用路由协议（如RIP、OSPF）来与其他路由器交换路由信息的。  
4. 地址掩码请求与地址掩码应答  
作用：为发送地址掩码请求的结点提供关于网络中其他计算机的子网掩码信息。  
网络中的某个结点可能直到另一个结点的IP地址，但它并不知道如何解释该IP地址，除非摘掉了应用于该地址的子网掩码。   
发送地址掩码请求消息的结点，通常使用单播或广播来把消息发送给路由器，路由器使用应答消息来响应该结点，告诉该结点本地网络所使用的子网掩码（该结点中的子网掩码也与本地网络中每台计算机的子网掩码相同）  
与路由器公告和路由器请求消息不同，路由器并不会有规律的公告子网信息，它们只有在响应网络结点的一个请求时，才会发送子网掩码信息。   
地址子网掩码请求和地址掩码应答消息也不是必须的，大多数计算机是通过DHCP来获得子网掩码信息的。  
5. Traceroute消息  
类似与Echo请求和Echo应答消息，但它并不是只用于测试基本的网络连通性。  
这种ICMPv4消息可跟踪数据包所经过的一系列路由器，通过这些路由器，逐跳地把数据包从源结点发送到目的地结点。  
在Windows系统中，这些消息是利用Tracert实用工具来发送的，在Linux中，使用的是Traceroute程序。虽然名称不同，但是但其底层的ICMPv4消息格式是相同的，一个Traceroute消息是作为单个数据包来发送的，它包含有一个特定的Traceroute IP选项，通过对这个选项的辨识，路由器把该数据包接收为一个测试消息。路由器沿路由路径把该数据包转发到目的地结点，每个转发了该消息的路由器，都会用一个Traceroute消息来应答源结点，这个Traceroute消息含有该路由器的IP地址和（或）名称，以及经过该路由器所需的时间（以毫秒为单位）。   

## 5.2.4 可变的ICMP结构和功能
一些ICMP数据包，如ICMP重定向必须在数据包的ICMP部分中发送特定的信息，这些数据包指出本节中定义的附加字段。   
各种ICMP报文的前32bits都是三个长度固定的字段，为8bit的type字段、8bit的code字段、16bit的校验和字段（包括icmp数据字段的校验和），而对于不同类型的icmp报文，其余下字段的含义则是不同的。   
### 类型0和8：Echo应答和Echo请求数据包
ICMP类型0：Echo应答数据包；  
ICMP类型8：Echo请求数据包；  
这些数据包中编码字段都为0，且这两个ICMP数据包使用相同的结构，如下：    
![Echo应答和请求](https://tse3-mm.cn.bing.net/th/id/OIP-C.JtGw2JKb9C2v8_99H0-CMgHaDA?pid=ImgDet&rs=1)  
RFC792：标识符（Identifier）和序列号（Sequence）字段用于协助将Echo应答与Echo消息匹配起来。如RFC792规定，标识符可以像TCP或UDP中的端口号那样用于标识会话，在发送每一个Echo请求时应该增加序列号，回应者在Echo应答中返回相同的值。 

Windows 2012、7、10的ping数据包含有以下特性：  
1. 标识符（LE）字段被设置为十进制256或0x100  
2. 在发送第一个Echo消息时，序列号字段的值被设置为十进制256（0x100）的倍数，在后续的每一次Echo消息中，该字段增加十进制256（0x100）  
3. 数据字段包含值“abcdefghijklmnopqrstuvwxyzabcdefghi”

再次注意标识符和序列号字段匹配了请求和应答。

### 类型3：目的地不可达数据包
网络故障诊断器经常密切跟踪ICMP目的地不可达数据包，ICMP目的地不可达数据包使用如下所示结构：  
![](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimage.mamicode.com%2Finfo%2F201809%2F20180902212649113706.png&refer=http%3A%2F%2Fimage.mamicode.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1656594633&t=18ecd304e8ec171628f7849cd7897488)   
如图所示，发送目的地不可达数据包的主机必须返回IP首部和触发该响应的原始数据报的8个字节。   
RFC文档交替使用术语Internet header（Internet 首部）和IP header（IP首部），而很多协议分析器包括wireshark使用术语IP header（IP首部）或Header（首部）。  
如上这种数据包可能会出现一个数据报中出现两个IP首部，记住，从头至尾阅读数据包时，识别出用于在网络中传输数据报的IP首部（数据包中第一个IP首部），以及只是用于标识问题的IP首部（第二个IP首部）。  
尽管RFC792只要求在ICMP应答中包含IP首部后面的8个字节，但是返回尽可能多的数据也是可以接收甚至时必要的。   

如上图所示，目前由16种可能的编码分配给了ICMP目的地不可达类型编号：  
1. 编码0：网络不可达，Net Unreachable，路由器可能发送编码0的数据包。表明，路由器知道入站数据包所用的网络号，但认为路由此刻不可达，或认为过于遥远而不可到达。  
2. 1：主机不可达，host unreachable，路由器发送这个应答，表明路由器无法定位目标主机，现在当目标网络未知时，也会发送这个应答。如ping IP地址后，出现的host unreachable，这种Echo应答消息，表示Echo请求数据包的目的地时不可达的，当主机离线，或交换机、路由器的部分网络发生故障时、或主机IP地址不存在时，会发生这种情况。  
3. 2：协议不可达，protocol unreachable，主机或路由器能够发送这种错误消息，表明定义在IP首部的协议不能被处理，例如，如果Internet组管理协议（Internet Group Management protocol，IGMP）数据包发送给某主机，该主机使用的TCP/iP栈不支持或不理解IGMP，该主机就会发送协议不可达消息。这个应答消息与包含在IP首部协议字段的值相关联。  
4. 3：端口不可达，port unreachable，

### 类型5：重定向
路由器向主机发送ICMP重定向（ICMP redirect）消息，表明存在一条更佳路由。ICMP重定向数据包拥有一个4字节字段，表示更佳网关地址。  
![](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimages.cnitblog.com%2Fblog%2F153130%2F201307%2F30084655-9b93870b3f3e4f7b8ccf05791cf7a7da.png&refer=http%3A%2F%2Fimages.cnitblog.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1656597258&t=547dcd5c2fb05081baf1cf5209f3298d)   
理想情况下，客户端应该更新其路由表，表明后继通信将要使用的最佳路径。由4个编码，它们定义了ICMP重定向数据报包含的新路由是完整的主机地址还是网络地址，此外，某些重定向信息指向了用于特定服务类型的路径。  
1. 编码0：网络（或子网）重定向数据报（redirect datagram for the network or subnet）。路由器能够发送这个ICMP消息，表明存在一条到达指定网络的更佳路径。由于路由器不能确定目的地址的哪一部分是网络地址部分，哪一部分是主机地址部分，因此它们在ICMP重定向应答消息中使用编码1.  
2. 编码1：主机重定向数据报（redirect datagram for the host）路由器能够发送这个ICMP消息，表明存在一条到达指定主机的更佳路径。这是在网络上最常见的ICMP重定向消息。   
3. 编码2： 服务类型与网络重定向数据报（redirect datagram for the type of service and network），路由器能够发送这个ICMP消息，表明存在一条使用期望服务类型到达指定网络的更佳路径，同样，由于路由器不能确定目的地址的哪一部分是网络部分，哪一部分是主机部分，因此它们在ICMP重定向应答消息中使用编码3来解决服务类型问题。  
4. 编码3： 服务类型和主机的重定向数据报（redirect datagram for the type of service and host）路由器能够发送这个ICMP消息，表明存在一条使用所需服务类型到达指定主机的更佳路径。  

### 类型9和10：路由器公告和路由器请求
主机发送路由器请求数据包，路由器使用路由器公告数据包进行响应。   
ICMP路由器请求数据包使用如下结构：  
IP首部
![](https://img-blog.csdnimg.cn/20200305112543263.png)  
这种请求数据包的结构很简单，只含有ICMP类型和编码编号，这种数据包默认情况下发送到全路由器多播地址224.0.0.2上。某些情况下，可以把主机配置为将这些数据包发送到广播地址上（在本地路由器不能处理多播数据包的情况下）。ICMP路由器公告数据包使用如下格式：  
数据链路首部  
![](https://img-blog.csdnimg.cn/20200305112554247.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjUyODI2Ng==,size_16,color_FFFFFF,t_70)    
ICMP路由器公告数据包在ICMP校验和字段之后还含有下述字段：  
1. 地址个数：在这个数据包中公告的路由器地址个数  
2. 地址长度: 用于定义所公告的每一个路由器地址的4字节增量个数。由于这个版本包括了一个4字节的优先级字段，以及4字节的IP地址字段，因此地址长度值为2（2+2+4字节）
3. 生存期：这个路由信息可以被认为有效的最大秒数  
4. 路由器地址1：发送路由器的本地IP地址  
5. 优先级1：所公告的每一个路由器地址的优先级值。值越大表示优先级越高。可以在路由器上配置更高的优先级（需要路由器支持），以便确保路由器更可能成为用于本地主机的默认网关。  
6. 路由器地址2和优先级2：如果存在其他的路由器值，它们将后随上其优先级。  

### 类型11：超时
路由器（当传输中生存时间超时）或主机（当分段重组超时）能够发送这些ICMP数据包。ICMP超时数据包结构如下：   

ICMP超时数据包的编码分为：
1. 编码0： 传输中生存时间超时（time to live exceeded in transit），路由器能够发送这些ICMP消息，表明到达了一个TTL值为1的数据包。路由器不能把TTL值减为0并转发这个数据包，因此它们必须丢弃这个数据包并发送这个ICMP消息。当路由器作为一个主机并重组数据包时，也可以发送编码1，即分段重组超时消息。     
2. 编码1： 分段重组超时（fragment reassembly time exceeded）当主机没有在所收到的第一个分段TTL值过期之前（以秒为单位的持有时间）收到所有分段部分时，发送这个ICMP消息。   
当分段集合中的第一个数据包到达目的地时，TTL值就相当于是“剩余生命时间的秒数”。定时器开始以秒为单位向下计数。如果分段集合中的所有分段在定时器过期之前没有全部到达，那么整个分段集合被认为无效。接收方将这一消息发送回分段结合的原始发起方，从而使得原始数据包重新发送。  

### 类型12：参数问题
这些错误表明发生了其他ICMP错误消息没有涵盖的其他问题。ICMP参数问题数据包结构如下：  

ICMP 参数问题数据包的编码分为：
1. 编码0： 指针值指示错误（pointer indicates the error）这个ICMP错误包含了一个指针字段，它表明错误发生在所返回的IP首部和数据报的什么地方。  
2. 编码1： 遗失所请求选项（missing a required option）表明发送方期待在原始数据包选项字段中包含某些附加信息。  
3. 编码2： 无效长度（bad length）表明原始数据包结构存在无效长度   

### 类型13和14：时间戳和时间戳应答
这个ICMP消息被定义为IP主机获取当前时间的一种方法。所返回的值是自午夜开始计时的世界时间毫秒数，世界时间（universal time，ut），以前称为格林尼治时间（Greenwich mean time，GMT）。ICMP时间戳和时间戳应答数据包都使用相同的结构，如下图：   
IP首部  
![](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fwww.pianshen.com%2Fimages%2F332%2F45ef22e2663fc1d36db53f7f4862fce4.JPEG&refer=http%3A%2F%2Fwww.pianshen.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1656680766&t=25c70d9396f0f4e707a67e66ff05dafa)  

时间戳请求方将当前发送时间放入到原始时间戳（originate timestamp）字段，接收方在数据包处理过程中将自己的当前时间值放入到接收时间戳（receive timestamp）字段，接下来在接收方在将数据报发送回请求方时刻将当前时间戳放入到传输时间戳（transmit timestamp）字段中。  
其他协议如网络时间协议（network time protocol，NTP），可提供健壮、用途更加广泛的时间同步方法。  

## 5.6 路径MTU发现
当需要修改那些通过ICMPv4消息发送的数据包的MTU大小时，IPv4网络中的路径MTU（path MTU，PMTU）发现允许路由器通过ICMPv4消息通知网络结点。每个PMTU是由源结点与目的地结点之间的链路组成的，每条链路具有不同的MTU大小。PMTU是链路中最小的MTU  
数据包的大小通常是利用分段或PMTU发现来管理的，如果链路连接的出站网卡具有比数据包大小更小的MTU，IPv4的常见做法是对数据包进行分段。根据源结点与目的地结点之间的不同链路，有时会对数据包进行多次分段，一旦所有分段都到达了目的地，目的地结点就会把分段重组成原始消息，然后再处理该消息。  
理想情况下，网络结点会发送尽可能大的数据包，如果这些数据包无需分段就可以穿过网络路径，就能一最高的效率传输消息。最初，所有数据包设置为576字节的MTU，即使是现在发送数据包的计算机也必须询问目的地结点，以便发送更大的数据包，而这往往是允许的。发送数据包的结点能更高效地传输数据包的另一种方式是，在数据包上设置不分段（don't fragnent，DF）标志。网络结点没有太多的路由信息，也不知道该在本地子网上设置多大的数据包MTU。如果这些数据包可以无误的通过，那么这些结点就继续发送具有该MTU的数据包并通过其默认路由器。  
如果数据包MTU过大，网络结点将接收到目的地不可达的ICMPv4消息，数据包不能交付的一个常见原因是，它们具有太大的MTU，且设置了DF标志，这样路由器不能对它们分段，当设置了DF标志而数据包MTU太大时，无法转发这些数据包的路由器，就会把这些数据包丢弃，然后给源结点发送一条需要分段的的消息。该结点就可以把数据包MTU设置得更小一些，或者去除DF标志，这样重新发送的数据包在需要时就可以分段了。  

PMTU的变化  
IPv6的MTU大小与分段已经进行了更新，以提高发送和接收网络数据流的效率和质量。一种方法是把数据包的默认MTU设置为1280字节，另一种方法是一旦数据包从源结点发送出去，就不允许对数据包分段。在传输中，IPv6路由器不能对数据包分段，如果需要对数据包分段，以便把它交付给目的地，那么必须由源结点来完成。  
PMTU发现已经在IPv4网络上使用了，但针对IPv6进行了很大改进。现在，源结点可以使用PMTU来得知任意网络路径上的最小链路MTU，并相应的设置数据包的MTU。但这并不是完美的，因为在传输的过程中，路由会发生变化，可能会把数据包路由到具有更小MTU的链路中去。由于路由器不能对这些数据包分段，因此将会丢弃它们，并发送数据包太大的ICMPv6消息给源结点。一旦源结点接收到数据包太大消息，它就会减小数据包的MTU大小，并重新传输。如果源结点随后又接收到数据包太大消息，它将会继续减小数据包的MTU大小，知道错误消息没有了为止。  
如果源结点需要对其数据包分段，那么它进行分段的方法，与结点和路由器对IPv4数据包进行分段的方法大体相同，只不过由于IPv6扩展首部的使用，使得这个过程更加复杂。这是因为，扩展首部（如目的地和逐跳选项）是不能分段的。IPv6数据包中任何不可分段的部分，都必须包含在原始数据包的每个分段中，然后发送分段后的数据包，并且，如果成功交付，由目的地结点把这些分段重组。  
第三章介绍了IPv6PMTU发现与数据包大小和分段。

# 5.7 ICMP测试和故障诊断程序
ICMP最常见的用法是测试和故障诊断，如ping、traceroute就是利用ICMP来完成可连接性测试和路径发现的。  
## 5.71 ping进行可连接性测试
ping实际上是ICMP Echo通信的一种形式，ICMP Echo请求数据包由以太网首部、IP首部、ICMP首部，以及一些不确定的数据组成。  
ICMP Echo请求是一个不保证成功交付的无连接过程，其实是一个尽最大努力传输的过程。

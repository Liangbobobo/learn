# TCP/IP中的数据链路层和网络层协议
TCP/IP协议对应osi参考模型的数据链路层和网络层  
当计算机要往不在其本地子网中的目的地发送一个数据包时，先把该数据包发送给它的默认网关（default gateway），然后该默认网关就把该数据包转发给真正的目的地，知道如何到达目的地的另一台路由器等等。   
通常默认网关就是一台路由器，或一台配置为类似路由器的服务器。  
## 4.1 数据链路层协议
数据链路层完成几个关键的任务，最重要的两项任务如下：  
1. 管理对所有网络介质（称为媒体访问控制MAC）的访问；  
2. 创建成MAC层地址之间的点到点链路，以便支持数据传输，称为逻辑链路控制LLC。  
这两个重要的功能和子协议，是IEEE在设计802系列网络规范时将数据链路层划分为MAC子层和LLC子层的原因。也是数据链路层支持数据从特定发送方传输到特定接收方的理由。这种传输称为点到点数据传输，它将数据从代表传输端点的特定MAC层地址运送到不同物理网段或TCP/IP子网上代表接收端点的另一特定MAC层地址。  
这种点到点的技术同样也能用于跨越广域网（wan）的数据传输（如模拟电话线路）、数字连接或X.25，这也是为什么有些TCP/IP数据链路协议有时候称为wan协议的原因。

data encapsulated数据封装：用于打包跨wan链路传输的数据包有效载荷，这些有效载荷与用于LAN连接的不同，并且包含了运行在数据链路层的专用协议，这些专用协议是：  
1. 点到点协议，PPP  
2. 高层数据链路控制  
3. 同步化的数据链路控制  
4. 通常情况下，需要对X.25，帧中继、异步传输模式（ATM）、连接进行特别处理，主要是确保为相关通信接口分配IP地址，并配置为传输TCP/IP流量，然而一旦建立，这些连接将固定使用PPP


## 4.2 点到点协议
PPP是一个通用协议，提供了类似于LAN封装的WAN数据链路封装服务。   
因此，PPP不仅提供了帧分界，而且提供了协议标识和位级完整性检查服务（点到点链路上不需要寻址，这种链路中只有两方参与通信）。

RFC1661提供了PPP的详细规范，并包括下述特性：  
1. 支持同一链路上同时使用多种协议的封装方法，PPP支持很多协议，如TCP/IP、AppleTalk、SNA、NetBEUI、IPX/SPX、DECnet等  
2. 一个特殊的链路控制协议（Link Control Protocol，LCP），用于协商使用PPP建立的任何点到点链路。  
3. 一组协商协议，用于建立点到点链路上所传输协议的网络层特性， 这组协议称为网络控制协议（network control protocol，NCP）。  
RFC1332、1877描述了一个用于IP的NCP，称为IP控制协议（Internet protocol control protocol，IPCP），用于协商发送方的IP地址、DNS服务器地址、以及可选的Van Jacobsen TCP压缩协议。

PPP封装和分帧技术是基于ISO高级数据链路控制（high-level DATA LINK CONTROL，HDLC）协议的，该协议又是基于IBM同步数据链路控制（Synchronous Data Link control，SDLC）协议，该协议是IBM公司的系统网络体系结构（system network architecture，SNA）协议的一个组成部分。但，没有必要先理解DHLC和SDLC再去理解PPP。用于PPP帧的HDLC分帧在RFC1662中有详细描述。  

尽管PPP分帧支持从HDLC派生来的寻址和链路控制信息，但绝大多数PPP实现使用了跳过这些非必要信息的缩略形式。取而代之，在PPP链路建立期间，LCP处理地址和控制字段信息，否则就省略这一信息，因此PPP的首部和尾部中的字段中包括：  
1. 标志（Flag）：标志是一个单字节的分界符字段，设置为0x7E（二进制值：01111110），表明了在一个PPP帧结束和另一个PPP帧开始之间的边界。  
2. 协议标识符：是一个2字节的字段，它标识PPP帧运送的上层协议。  
3. 帧校验序列（FCS，frame check sequence）：2字节字段，它提供了所发数据的位级完整性检查，接手之后将重新计算该校验序列，如果两个值一致，可以认为数据被成功传输，如果不一致，那么有效载荷被丢弃。

PPP必须提供一种替换可能出现在帧有效载荷中的标志值的方法。  

PPP还支持多链路实现，使得相同宽带的多个数据通道被合并，在单个发送方和单个接收方之间处理单一的数据流。

PPP支持1500字节的默认最大传输单元（MTU），这个长度对基于以太网的网络或设备，很理想。然而，依据所连接的网络的类型，LCP能够在PPP对等实体之间协商更大或更小的MTU，许多千兆以太网支持超大帧（jumbo frame），其MTU为9216字节，因此只要他们之间的PPP连接能够处理这样的大型帧，PPP就能够传输他们。


## 4.3帧的类型与大小
在数据链路层，协议数据单元称为帧frame。  
帧表示的数据，与网络层IP数据报中以数字形式表示的数据和映射到数据的任何电信号序列形式表示的数据都相同。因此，来自IP数据报的信息可以以各种帧类型进行封装。

### 4.31 以太网帧类型
Ethernet Ⅱ frame type以太网Ⅱ帧类型：用于在以太网上传输IP数据报的事实标准类型。Ethernet Ⅱ帧有一个协议标识字段（protocol indentification field）,即类型（TYPE）字段，它包含的值为0x0800，用于标识该封装协议为IPv6。  
在IP数据报发送到电缆线上之前，数据链路层驱动程序将前导帧加在数据报上。  
该驱动程序还要确保这个帧满足最小帧大小规范的要求，最小以太网帧为64字节，最大为1518字节。  
如果某个帧不能满足最小帧大小64字节的要求，那么驱动程序必须填充数据（DATA）字段。  
源节点或传输以太网网卡（NIC）对帧的内容执行一个循环冗余校验（CRC，cyclical redundancy check），并把一个值放在帧末尾的帧校验序列（FCS）字段中。   
最后，网卡发送该帧，前面放置前导码（preamble），它是一个接收方用于正确地把位解释为1或0额前导位模式。

TCP/IP能够使用两种以太网帧类型：  
1. Ethernet Ⅱ   
2. Ethernet 802.2逻辑链路控制

### 4.3.2 Ethernet Ⅱ帧结构，是用在以太网TCP/IP网络上最流行的帧结构。
Ethernet Ⅱ帧类型是Windows 2000及以后版本在以太网上用于TCP/IP的默认帧类型。   
Ethernet Ⅱ帧的格式：   
Ethernet Ⅱ帧类型由以下字段和结构构成：  
1. 前导码（preamble）：8字节，由0或1组成。放在实际以太网帧的前面，并且不算做整个帧长度的一部分。最后一个字节是一种模式，称为帧首分界符（start frame delimiter，SFD），值为10101011，表示目的地址字段的开始。这个字段提供了接收方用于解释帧中1和0的必要计时，这对以太网电路识别和开始读取入站数据具有时间必要性。    
2. 目的地址（destination address）字段：6字节，表明目的地IP主机的数据链路地址（DATA LINK ADDRESS），也成为硬件地址（hardware address），mac地址。地址解析协议（arp），用于获得目的地IP主机的硬件地址（如果目的地主机在本地），或者获得吓一跳路由器的地址（如果目的地主机是远程主机的）  
3. 源地址（source address）字段：6字节，表明发送方的硬件地址，该字段只包含一个单播地址，不能包含多播或广播地址。  
4. 类型（TYPE）字段：2字节，标识正在使用该帧类型的协议  
5. 帧校验序列（frame check sequence）字段：4字节，包括CRC的计算结果。  

已分配协议类型：  
```
0x0800 ipv4
0x86dd ipv6
0x0806 arp
0x809B appletalk 
0x8137 Novell 互联网包交换（internetwork packet exchange，IPX）
```
更多以太网介质上TCP/IP组网的信息，RFC894

一旦接收到Ethernet Ⅱ帧，IP主机通过对其内容执行CRC校验，并将结果与包含在帧校验序列字段中的值相比较，以检查其内容的有效性。  
在确认目的地是接收方地址（或广播地址，或可接受的多播地址）后，接收网卡去除帧校验序列字段，并把帧递交给数据链路层。  
在数据链路层，检查帧以确认实际的目的地址（广播、多播、单播）。此刻，协议标识符字段（如，Ethernet Ⅱ帧结构中的类型字段）被检查，之后剩余的数据链路帧结构被去除，以便帧能够向上交付给适宜的网络层（这里是IP）

## Ethernet 802.2 LLC帧结构，IP通常看不到这个帧类型
Ethernet 802.2 LLC帧类型与Ethernet Ⅱ类似，使用SPA字段代替类型字段（TYPE）来标识使用该帧的协议。值0x06分配给了IP。  
Ethernet 802.2 LLC帧类型由如下字段构成：  
1. 前导码（preamble）：7字节，由1和0组成，与EthernetⅡ帧结构不同，这个前导码不以连续的1结束。起始帧分界符（start frame delimiter）字段用于标记目的地址地段的开始  
2. SFD字段：1字节，由模式10101011组成，指明目地址字段的开始。802.2前导码和起始帧分界字符合起来等于Ethernet Ⅱ帧的前导码长度。  
3. length长度字段：2字节，表示帧的数据部分的字节数。在0x002E和0x05DC（十进制46和1500）之间。这种帧在这个位置不使用类型字段，而使用访问服务点（SAP）字段来表明协议。  
4. 目的服务访问点（destination service access point，DSAP）字段：1字节，指明目的地协议。  
5. 源服务访问点（source service access point，SSAP）字段：1字节，指明源协议，通常与目的地协议相同。  
6. 控制字段：1字节，指明该帧是未编号格式连接（无连接）或是信息/监督格式（用于面向连接和管理目的）  
7. 目的地址，destination address  
8. 源地址，source address  
9. 数据data  
10. frame check sequence

已分配的SAP编号

## 4.4IP环境中的硬件地址
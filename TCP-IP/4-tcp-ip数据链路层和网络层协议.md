# TCP/IP中的数据链路层和网络层协议
TCP/IP协议对应osi参考模型的数据链路层和网络层  
当计算机要往不在其本地子网中的目的地发送一个数据包时，先把该数据包发送给它的默认网关（default gateway），然后该默认网关就把该数据包转发给真正的目的地，知道如何到达目的地的另一台路由器等等。   
通常默认网关就是一台路由器，或一台配置为类似路由器的服务器。  
## 4.1 数据链路层协议
数据链路层完成几个关键的任务，最重要的两项任务如下：  
1. 管理对所有网络介质（称为媒体访问控制MAC）的访问；  
2. 创建成MAC层地址之间的点到点链路，以便支持数据传输，称为逻辑链路控制LLC。  
这两个重要的功能和子协议，是IEEE在设计802系列网络规范时将数据链路层划分为MAC子层和LLC子层的原因。也是数据链路层支持数据从特定发送方传输到特定接收方的理由。这种传输称为点到点数据传输，它将数据从代表传输端点的特定MAC层地址运送到不同物理网段或TCP/IP子网上代表接收端点的另一特定MAC层地址。  
这种点到点的技术同样也能用于跨越广域网（wan）的数据传输（如模拟电话线路）、数字连接或X.25，这也是为什么有些TCP/IP数据链路协议有时候称为wan协议的原因。

data encapsulated数据封装：用于打包跨wan链路传输的数据包有效载荷，这些有效载荷与用于LAN连接的不同，并且包含了运行在数据链路层的专用协议，这些专用协议是：  
1. 点到点协议，PPP  
2. 高层数据链路控制  
3. 同步化的数据链路控制  
4. 通常情况下，需要对X.25，帧中继、异步传输模式（ATM）、连接进行特别处理，主要是确保为相关通信接口分配IP地址，并配置为传输TCP/IP流量，然而一旦建立，这些连接将固定使用PPP


## 4.2 点到点协议
PPP是一个通用协议，提供了类似于LAN封装的WAN数据链路封装服务。   
因此，PPP不仅提供了帧分界，而且提供了协议标识和位级完整性检查服务（点到点链路上不需要寻址，这种链路中只有两方参与通信）。

RFC1661提供了PPP的详细规范，并包括下述特性：  
1. 支持同一链路上同时使用多种协议的封装方法，PPP支持很多协议，如TCP/IP、AppleTalk、SNA、NetBEUI、IPX/SPX、DECnet等  
2. 一个特殊的链路控制协议（Link Control Protocol，LCP），用于协商使用PPP建立的任何点到点链路。  
3. 一组协商协议，用于建立点到点链路上所传输协议的网络层特性， 这组协议称为网络控制协议（network control protocol，NCP）。  
RFC1332、1877描述了一个用于IP的NCP，称为IP控制协议（Internet protocol control protocol，IPCP），用于协商发送方的IP地址、DNS服务器地址、以及可选的Van Jacobsen TCP压缩协议。

PPP封装和分帧技术是基于ISO高级数据链路控制（high-level DATA LINK CONTROL，HDLC）协议的，该协议又是基于IBM同步数据链路控制（Synchronous Data Link control，SDLC）协议，该协议是IBM公司的系统网络体系结构（system network architecture，SNA）协议的一个组成部分。但，没有必要先理解DHLC和SDLC再去理解PPP。用于PPP帧的HDLC分帧在RFC1662中有详细描述。  

尽管PPP分帧支持从HDLC派生来的寻址和链路控制信息，但绝大多数PPP实现使用了跳过这些非必要信息的缩略形式。取而代之，在PPP链路建立期间，LCP处理地址和控制字段信息，否则就省略这一信息，因此PPP的首部和尾部中的字段中包括：  
1. 标志（Flag）：标志是一个单字节的分界符字段，设置为0x7E（二进制值：01111110），表明了在一个PPP帧结束和另一个PPP帧开始之间的边界。  
2. 协议标识符：是一个2字节的字段，它标识PPP帧运送的上层协议。  
3. 帧校验序列（FCS，frame check sequence）：2字节字段，它提供了所发数据的位级完整性检查，接手之后将重新计算该校验序列，如果两个值一致，可以认为数据被成功传输，如果不一致，那么有效载荷被丢弃。

PPP必须提供一种替换可能出现在帧有效载荷中的标志值的方法。  

PPP还支持多链路实现，使得相同宽带的多个数据通道被合并，在单个发送方和单个接收方之间处理单一的数据流。

PPP支持1500字节的默认最大传输单元（MTU），这个长度对基于以太网的网络或设备，很理想。然而，依据所连接的网络的类型，LCP能够在PPP对等实体之间协商更大或更小的MTU，许多千兆以太网支持超大帧（jumbo frame），其MTU为9216字节，因此只要他们之间的PPP连接能够处理这样的大型帧，PPP就能够传输他们。


## 4.3帧的类型与大小
在数据链路层，协议数据单元称为帧frame。  
帧表示的数据，与网络层IP数据报中以数字形式表示的数据和映射到数据的任何电信号序列形式表示的数据都相同。因此，来自IP数据报的信息可以以各种帧类型进行封装。

### 4.31 以太网帧类型
Ethernet Ⅱ frame type以太网Ⅱ帧类型：用于在以太网上传输IP数据报的事实标准类型。Ethernet Ⅱ帧有一个协议标识字段（protocol indentification field）,即类型（TYPE）字段，它包含的值为0x0800，用于标识该封装协议为IPv6。  
在IP数据报发送到电缆线上之前，数据链路层驱动程序将前导帧加在数据报上。  
该驱动程序还要确保这个帧满足最小帧大小规范的要求，最小以太网帧为64字节，最大为1518字节。  
如果某个帧不能满足最小帧大小64字节的要求，那么驱动程序必须填充数据（DATA）字段。  
源节点或传输以太网网卡（NIC）对帧的内容执行一个循环冗余校验（CRC，cyclical redundancy check），并把一个值放在帧末尾的帧校验序列（FCS）字段中。   
最后，网卡发送该帧，前面放置前导码（preamble），它是一个接收方用于正确地把位解释为1或0额前导位模式。

TCP/IP能够使用两种以太网帧类型：  
1. Ethernet Ⅱ   
2. Ethernet 802.2逻辑链路控制

### 4.3.2 Ethernet Ⅱ帧结构，是用在以太网TCP/IP网络上最流行的帧结构。
Ethernet Ⅱ帧类型是Windows 2000及以后版本在以太网上用于TCP/IP的默认帧类型。   
Ethernet Ⅱ帧的格式：   
Ethernet Ⅱ帧类型由以下字段和结构构成：  
1. 前导码（preamble）：8字节，由0或1组成。放在实际以太网帧的前面，并且不算做整个帧长度的一部分。最后一个字节是一种模式，称为帧首分界符（start frame delimiter，SFD），值为10101011，表示目的地址字段的开始。这个字段提供了接收方用于解释帧中1和0的必要计时，这对以太网电路识别和开始读取入站数据具有时间必要性。    
2. 目的地址（destination address）字段：6字节，表明目的地IP主机的数据链路地址（DATA LINK ADDRESS），也成为硬件地址（hardware address），mac地址。地址解析协议（arp），用于获得目的地IP主机的硬件地址（如果目的地主机在本地），或者获得吓一跳路由器的地址（如果目的地主机是远程主机的）  
3. 源地址（source address）字段：6字节，表明发送方的硬件地址，该字段只包含一个单播地址，不能包含多播或广播地址。  
4. 类型（TYPE）字段：2字节，标识正在使用该帧类型的协议  
5. 帧校验序列（frame check sequence）字段：4字节，包括CRC的计算结果。  

已分配协议类型：  
```
0x0800 ipv4
0x86dd ipv6
0x0806 arp
0x809B appletalk 
0x8137 Novell 互联网包交换（internetwork packet exchange，IPX）
```
更多以太网介质上TCP/IP组网的信息，RFC894

一旦接收到Ethernet Ⅱ帧，IP主机通过对其内容执行CRC校验，并将结果与包含在帧校验序列字段中的值相比较，以检查其内容的有效性。  
在确认目的地是接收方地址（或广播地址，或可接受的多播地址）后，接收网卡去除帧校验序列字段，并把帧递交给数据链路层。  
在数据链路层，检查帧以确认实际的目的地址（广播、多播、单播）。此刻，协议标识符字段（如，Ethernet Ⅱ帧结构中的类型字段）被检查，之后剩余的数据链路帧结构被去除，以便帧能够向上交付给适宜的网络层（这里是IP）

## Ethernet 802.2 LLC帧结构，IP通常看不到这个帧类型
Ethernet 802.2 LLC帧类型与Ethernet Ⅱ类似，使用SPA字段代替类型字段（TYPE）来标识使用该帧的协议。值0x06分配给了IP。  
Ethernet 802.2 LLC帧类型由如下字段构成：  
1. 前导码（preamble）：7字节，由1和0组成，与EthernetⅡ帧结构不同，这个前导码不以连续的1结束。起始帧分界符（start frame delimiter）字段用于标记目的地址地段的开始  
2. SFD字段：1字节，由模式10101011组成，指明目地址字段的开始。802.2前导码和起始帧分界字符合起来等于Ethernet Ⅱ帧的前导码长度。  
3. length长度字段：2字节，表示帧的数据部分的字节数。在0x002E和0x05DC（十进制46和1500）之间。这种帧在这个位置不使用类型字段，而使用访问服务点（SAP）字段来表明协议。  
4. 目的服务访问点（destination service access point，DSAP）字段：1字节，指明目的地协议。  
5. 源服务访问点（source service access point，SSAP）字段：1字节，指明源协议，通常与目的地协议相同。  
6. 控制字段：1字节，指明该帧是未编号格式连接（无连接）或是信息/监督格式（用于面向连接和管理目的）  
7. 目的地址，destination address  
8. 源地址，source address  
9. 数据data  
10. frame check sequence

已分配的SAP编号

# 4.4IP环境中的硬件地址
IP地址用于标识TCP/IP互联网络上的单台主机。  
在单个网络中将数据包从一台IP主机传输到另一台IP主机时，需要使用硬件地址。例如，将数据包从一台IP主机传输到位于路由器另一端的另一台IP主机，源主机需要知道目的地IP主机的IP地址。  
源主机必须执行某种形式的硬件地址解析来知晓路由器的硬件地址，以便它能够构造数据链路首部（如以太网首部），使数据包能够传输到本地路由器或默认网关上。当路由器收到数据包时，路由器也必须经历相同的硬件地址解析过程，以便确定数据包的下一个本地硬件地址。  

## 4.41 地址解析协议与网络发现协议
address resolution protocol，ARP：是IPv4结点用于把网络层或IP层地址解析到数据链路层或物理层地址的协议。  
IPv6在这个过程中不是使用ARP而是使用邻居发现协议（neighbor discovery protocol，NDP）。  
区别：  
NDP运行在ICMPv6上，使用多播数据包而不是广播数据包。每个IPv6网络结点都会对请求结点多播地址进行侦听，该地址组成了该结点的单播地址的最后3个字。发送邻居请求消息的结点，会把该消息发送给，其他结点的，请求结点多播地址。这可以防止其他结点被邻居请求打扰。  

### 4.4.2 ARP协议的特性与处理
TCP/IP组网使用ARP确定数据包本地目标的硬件地址。ARP仅仅用于寻找本地IP主机的硬件地址，ARP是不可路由的，它在数据包结构中没有网络层部件。  
IP主机在内存中维护一个ARP缓冲区，一张通过ARP过程知晓的硬件地址表。在向网络发出ARP请求之前（基于广播的），IP主机首先引用ARP缓冲区，如果所需的硬件地址在缓冲区没有被找到，IP主机广播一条ARP请求。  
ARP还能用于测试网络上是否存在重复的IP地址，当IP主机在IP网络上开始通信之前，他应该完成重复IP地址测试，即IP主机向其自身拥有的IP地址发送一个ARP请求（称为无偿ARP，gratutious ARP），如果另一台主机相应重复IP地址测试，得到一条该IP已用的应答，那么主机就不能够初始化其TCP/IP栈。  

如果IP目标是远程目标，在另外一个网络上，那么IP主机必须引用其路由表（routing table）来确定该数据包的正确路由，这称为路由解析协议route resolution protocol，RRP  

### ARP数据包字段和功能
默认情况下，Windows vista和7对所有ARP流量都使用EthernetⅡ帧类型。  
有两种基本的ARP数据包：广播ARP请求数据包和定向的（或单播）ARP应答数据包，这两种数据包使用相同的格式。  
ARP最容易混淆的部分是发送发和目标地址信息的解释。当ARP广播从一台主机上发送时，发送主机在发送方sender address字段中放置硬件地址和IP地址。目标Internet地址（target Internet address）字段包含了预期IP主机的IP地址，目标硬件地址（target hardware address）字段全设置为0，指明其信息是未知的。  
ARP规范规定目标硬件地址字段能够被设置为不全是0的其他值，


### 代理ARP proxy ARP
是一种允许IP主机使用简化子网设计的方法。proxy ARP使得路由器能够做ARP，以便响应IP主机的ARP广播。


# 4.5理解IP协议
网络层协议的主要功能是使数据报在由路由器连接的网络上移动。  
网络层通信是端到端通信，它将源网络层地址定义为发起方，将目的网络层地址定义为目标。  
当数据包发送给网络路由器时，这些路由器会根据所使用的可路由协议来检查目的网络地址，以确定转发数据包的方向（如果需要）。    
Internet协议（IP协议）是TCP/IP协议簇中的网络层协议，本节只关注IPv4。
## 4.5.1发送IP数据报
IP提供了端到端网络层寻址的无连接服务。  
数据包转发时，路由器去除数据链路首部，重新添加另一个数据链路首部。  

要构造一个在线路上传输的IP数据报我们必须知道：  
1. 源地址和目的地IP地址  
2. 源和下一跳路由器的硬件地址   
IP主机能够使用手工输入的目的地IP地址或使用DNS得到目的地IP地址。  

在发起ARP过程之前，IP主机必须知道目的地是位于本地还是远程。IP主机应该直接向预定目的地发送数据包，还是应该把数据包发送给本地路由器，这称为路由解析过程。一旦路由解析过程完成，IP主机能够开始ARP过程，以确定预期目的地的硬件地址。

## 4.5.2路由解析过程
路由解析过程让IP主机确定预期目标是本地的还是远程的。如果目标是远程的，这一过程让IP主机确定下一跳路由器。  

如果是远程的，使用哪一个路由器？  
本地IP主机知道目的地是远程设备，IP主机必须为数据包确定恰当路由器的硬件地址，硬件地址仅仅用于将网络上一台IP主机的数据包传输给同一网络上另一台IP主机。   
路由器收到发往其硬件地址的数据包时，去除数据链路层首部，检查网络层首部以确定如何路由该数据报，然后重新加上数据链路首部，将数据包传输给下一个网络。

IP主机查找其本地路由表，以确定是否有达到目标的路由项。存在两种类型的路由表登记项：主机路由表登记项（host route entry）、网络路由表登记项（networke route entry）。  
主机登记项匹配目的地址的所有4个字节，并指明能够把数据报转发到预定目标的本地路由器。  
网络登记项指明达到目的地网络的路由已知，但到达目标主机的路由未知。因为是由最接近目标的路由器负责将数据包传递给目标主机，所以通常有这样的信息也就足够了。  
以同等优先级原则对待所有路由登记项是常见做法，然而，发送主机将选择一个具有最多匹配位的登记项。如，有32位掩码与预期目标的32位匹配的登记项，优先于只有24位掩码与预期目标24位匹配的登记项。  
如果既没有主机登记项，又没有网络登记项，IP主机检查其默认网关登记项。概括的说，本地主机检查自己的路由表，寻找特定主机的路由，之后寻找网络路由，当两者都失败时，再使用默认网关路由。  
默认网关提供了默认路由，一条盲目信任的路径。由于IP主机没有达到目标的路由，它就将数据报发送给默认网关，希望默认网关能够做出如何处理该数据包的决定。   
无论数据包是发送到默认路由（默认网关），还是定位在主机路由表中的特定路由，接收网关通常做下述事情之一：  
1. 转发数据包，如果他们有一个到达目标的路由的话。  
2. 发送ICMP应答，称为ICMP重定向，它指向拥有到达目标最佳路由的另一个本地路由器。
3. 发送ICMP应答，指明不清楚向什么地方发送数据包，目标不可达。

如果目标是远程目标，并且处理数据报的源设备或网卡知道能够转发数据包的下一跳路由器或默认网关，源设备必须使用ARP解析下一跳路由器或默认网关的硬件地址。自然地，源设备首先检查其ARP缓冲区，如果信息在缓冲区中不存在，源设备发送ARP广播或取下一跳路由器的硬件地址。

如果IP主机不能互相通信，可以使用协议分析器来确定发生了什么错误，有可能发生了如下问题：  
1. IP主机只能对本地的主机进行ARP解析，而实际目标是远程地址（检查源子网掩码和目标的IP地址）  
2. 目标主机是本地的，但由于它没能完整地发挥功能，而没有对ARP做出应答（检测到重复IP地址，或目标关机了）  
3. 源设备从名称解析过程（如DNS）中得到的IP地址不正确（没有哪个IP主机使用了预期的IP地址）
# IP寻址
IP使用一种三部分寻址模式：符号名、逻辑数字地址、物理数字地址。   
符号名symbolic name，www.baidu.com，又称为域名domain name，要使域名有效，他必须对应至少一个唯一的数字ip地址；域domain，是连接成一个网络并作为一个单元进行管理的计算机设备集。   

ipv6，一个地址由128个位组成的，表示成一系列十六进制的值。该地址分成8个分组，每个分组有4个字符，16个位，每个分组又称为字，每个字之间用：分开，如果地址中有连续的0，可以省略0。

把ipv4十进制地址和ipv6十六进制地址理解成逻辑网络地址很重要，每一个数字IP地址在iso/osi网络参考模型的网络层（tcp/ip网络模型的网际层）中发挥着作用，它将一组唯一的数字分配给网络上的每一个网卡。IP协议同样可以作用于osi模型的网络层。

物理数字地址：是一个6字节的数字地址，是由网卡制造商固化到固件（在一个芯片上）的。前三个字节（成为组织唯一标识符organizationally unique indentifier，OUI）标识所用网卡的制造商；后三个字节是另一种唯一标识符，由制造商分配。这使得网络上任何一块网卡都拥有一个唯一的物理数字地址（physical numeric address）   
物理数字地址在媒体访问控制mac层（数据链路层的一个子层）中发挥作用，物理数字地址又称为mac层地址。   
数据链路层软件中的逻辑链路控制logical link control，LLC，子层，使得网卡与同一物理电缆或网络段上的其他网卡建立点到点的连接。   
arp用于使计算机把数字IP地址转换为mac层地址   
rarp用于将mac地址转换为IP地址


## 2.2 IPv4寻址
IPv4中每一个数字都是8位，标准IP属于是八位元组，对任何要解析为网络地址的域名来说，域名都必须对应至少一个数字IP地址

不允许出现重复的数字IP地址，否则将会导致混乱。  
当重复发生时，拥有真正IP地址的网卡会遇到这样的问题，网络上分享同一个地址的网卡就会中断会话或者是先到先服务。因此，如果为某台机器配置IPv4地址，但该机器不能访问网络，就有理由推测该ipv4地址出现了重复。   
最常见的ipv4地址配置错误是使用了不正确的子网掩码，更为重要的是，如果你注意到另一台机器也几乎同时变为不可用了，那么就可以肯定是出现了地址重复。

### 2.2.1 ipv4地址类
IPv4地址被进一步划分为5类，从A类到E类。   
对于前三类，按下述方式划分八位字节，表示其行为：   
A类--n h.h.h  
B类--n.n h.h  
C类--n.n.n h  
n代表网络地址部分，用于按数字识别网络，h代表主机地址部分，用于按数字识别主机。   
D类用于多播地址，在这种通信方式下，单个地址可以和多个网络主机相关联。当信息被一次广播到多个接收方或一组预先选定的接收方时，这种方式才有用。因此，视频和电话会议使用的是多播地址。还有如路由器等设备，经常更新相同的信息时，多播地址也很方便。  
E类地址被保留用于实验目的

### 2.2.2 网络、广播、多播、及其他特殊IP地址
通常情况下当IP数据包从发送方传输到接收方时，地址的网络部分引导数据流从发送方网络传输到接收方网络。当发送方和接收方都位于同一个物理网络或子网时，地址的主机部分才发挥作用。   
尽管对从机器到机器的大多数传输来说，数据帧可以从一个网络到另一个网络，但这些传输的绝大多数都是仅仅在数据包非常接近目标网络时发生。   
在局域网中，尽管有各种各样的数据在传输，但某个主机正常情况下仅仅读取发送给它的入站数据流，或者读取出于其他原因必须读取的数据流，如导向该主机上某个活动服务的多播数据流。

任何主机部分全为0的IPv4地址，都表示该网络本身的地址。网络地址不能标识网络上的特定主机，网络地址标识的是整个网络本身。   
任何主机部分全为1的ipv4地址，如10.255.255.255，成为广播地址（broadcast address），代表网络上所有主机都必须读取的一个网络地址。现在广播数据流几乎不会从一个物理网络转发到另一个物理网络，分割网络的路由器会把广播过滤掉，绝大多数情况下，广播保持为一种纯本地形式的数据流，但DHCP客户端发出DHCP offer消息时除外（第七章）

### 2.2.3广播数据包结构
IPv4广播数据包有两个目的地址字段，一个是数据链路层的目的地址字段，一个是目的网络地址字段。   

当主机使用某个采用多播地址的服务时，它将自己注册为侦听该地址，同时也侦听自己的唯一主机地址。该主机还必须通知其IP网关（将数据转发给该主机所在物理网络的路由器或其他设备）它正在注册该服务，以便把这样的多播数据流转发到该网络中，否则的话，这些数据永远不会出现在这个网络中。   
注册过程通知网卡将发送给该地址的数据包传递给IP栈，

未完成

### 2.2.4IPv4网络和子网掩码
如果两个网卡位于同一物理网络上，那么他们可以在mac层直接相互通信。

### 2.2.5 IPv4子网和超网
从路由的观点来看，子网和超网的概念指的都是在这样的网络上的单个本地邻居。   
当网络地址被进一步划分，超出了地址所属类的默认划分时，这种子网划分subnetting代表了从地址的主机部分借入位，并使用这样的借入位在单个网络地址环境下创建多个路由区域。子网掩码比默认掩码更大，

从路由的观点来看，子网划分使网络管理员可以将子网匹配到网络上的实际路由区域，以便同一物理网络上的机器能使用mac层地址通信。其他没有安装在同一物理网络上，但希望通信的机器，属于不同的子网，它们的数值IP地址在这些子网部分存在不同，这正是前面所说的数值邻居真实含义发挥作用的地方。  

当一个子网上的计算机希望和另一个子网上的计算机通信时，数据必须从发送方转发到临近的IP网关，以便将消息从一个子网发送到另一个子网。   
IP网关：是一个把多个IP网络或子网互联连接起来的设备。经常称它为路由器上的一个接口，因为它通常存储了许多网络的路由表可达信息，对收到的每一个数据包选择最佳（最短、最快、或最不昂贵）路径进行路由，之后将数据包送上旅途。

子网划分意味着从地址的主机部分窃入一些位并使用这些位把单个网络地址划分位称之为子网的多个部分。   
超网划分supernetting：通过把连续的网络地址结合起来，从网络部分嵌入一些位，使用他们构建一个用于主机的单一的、连续的地址空间。   
RFC1878

子网掩码：  
1. 固定长度子网掩码constant-length subnet masking，CLSM：每一个子网中包含相同数量的工作站。  
2. 变长子网掩码 variable-length subnet masking，VLSM：把单个地址划分为多个子网，其中的子网并不需要都是一样大小的。   
详见：www.di.unipi.it/~ricci/501302.pdf   
两个相关的工具：

CIDR是英文“Classless Inter-Domain Routing”的简写，中文名称“无类别域间路由”，是网络中分配IP地址的一种方法。  
CIDR抛弃了传统的ABC类IP地址以及划分子网的概念，减轻了路由表数据过大的问题。CIDR使用如下格式的IP地址表示法：  
``` [网络前缀][主机地址]/网络前缀所占位数 ```

CIDR将IP地址划分为网络前缀和主机地址两个部分，“/”斜线后面是网络前缀所占的位数，这样通过网络前缀所占的位数就可以得到子网掩码。  
例如：192.168.0.1/24  
这是一个局域网的CIDR格式地址，IP地址192.168.0.1的二进制表示法是：  
11000000 10101000 00000000 00000001  
前24位是网络前缀，后8位是主机地址，令主机地址分别为全0和全1就可以得到一个CIDR地址块的最小地址和最大地址，即：  
最小地址：11000000 10101000 00000000 00000000 = 192.168.0.0  
最大地址：11000000 10101000 00000000 11111111 = 192.168.0.255  
令网络前缀全1，主机地址全0，就可以得到子网掩码：  
子网掩码：11111111 11111111 11111111 00000000 = 255.255.255.0  

可以看到，相对于使用IP地址+子网掩码的方法，CIDR格式地址更加简洁。

### 公用和专用IPv4地址
任何机构都可以在自己的组网区域中使用专用IP地址，而无需得到许可和支付费用   
```
A类  10.0.0.0~10.255.255.255     1个网络   16777214个主机 2的24次方减去网络数乘以2（每个网络都有两个特定主机）
B类  172.16.0.0~172.31.255.255   16个网络  1048544个主机  2的20次方减去网络数乘以2（每个网络都有两个特定主机）
C类  192.168.0.0~192.168.255.255 256个网络 65024个主机    2的16次方减去网络数乘以2（每个网络都有两个特定主机）
```
当选择使用要使用的专用IPv4地址种类时，对于小型网络每个子网由254台主机没有什么问题，但有时候需要在对每个子网主机数量需求与把大的地址类（通常是B类），划分子网还是把较小的地址类（通常是C类）合并为超网之间进行权衡，一种方法是使用B类地址，并在第三个八位字节进行子网划分，将第四个八位字节用于主机地址。   

专用IP地址的缺点之一是其不能在公共Internet上被路由，如果想把计算机连接到Internet上，并且在自己的本地网络内部使用专用IP地址，那么必须在网络专用一方与Internet公用一方之间的边界上的设备添加附加软件，以便使连接能够工作。有时，这与从一个或多个专用IP地址传输到公用IP地址的出站数据，以及相反方向传输的入站数据有关。   
另一种技术（地址伪装address masquerading或地址替代）可以在包含下述代理服务器能力的边界设备上运行：在出站数据离开服务器时，将专用IP地址替换为一个或多个公用IP地址，让入站数据经过服务器时，将公用地址替换为等同的专用地址。

专用IP地址的另一个缺点：某些IP服务要求端到端连接（end-to-end connection），即IP数据必须能够以加密形式在发送方和接收方之间传输（无需中间转换）。这种情况下，当连接的一方使用公用IP地址时，如果双方都使用一个公用IP地址时，最容易配置。原因在于，用于连接专用端的地址不能在Internet上被路由。

公开访问服务器不仅需要使用公用IP地址（否则他们不能公开访问），而且这些地址尽可能少变动，以便使遍布在Internet上的众多转换信息副本能尽可能正确更新。这意味着，绝大多数机构需要把公用IP地址用于如下两类设备：  
1. 支持机构把网络连接到Internet上的设备。这些设备包括提供网络上“外部”和“内部”之间边界的所有类型边界设备的外网卡，这些设备可以是路由器、代理服务器、防火墙。  
2. 设计用于Internet可访问的服务器。这些服务器包括，公用web服务器、电子邮件服务器、FTP服务器、新闻服务器、以及机构希望展示在公用Internet上的其他各种TCP/IP应用层服务。


### 2.2.8
使用专用IPv4地址要求有NAT或类似地址替换或伪装能力，  
某些机构即使在自己内部网络中使用有效公用IP地址时，也会选择使用地址替换或伪装。因为，如果支持网络边界的内部客户端与外部网络交互，但没有实现某种形式的隐藏，会将内部网络的地址机构暴露给具有专业知识的外部人，他们可能使用这些信息突破机构的边界（即从公共的Internet进入机构的网络环境），并出于各种理由攻击该网络。

代理服务器或某种类似的服务器，将自己插入在边界内部数据流和边界外部数据流之间。当来自内部网络的出站数据流穿越代理时，代理服务器将内部网络地址转换为一个或多个不同地址，以便实际穿越公共Internet的数据流不会向外部人披露内部网络的地址结构。  
同样，代理服务器能提供反向代理（reverse proxying）。它支持代理服务器代表边界内部的服务器，其方法仅仅是向外部世界发布代理服务器的地址，之后仅仅将对服务器的合法请求转发给内部服务器做进一步处理。外部人仅仅能看到代理服务器代表内部服务器公告地址，并且在绝大多数情况下不可见的中间人依然不被察觉。  
代理服务器提供的最重要服务之一是：管理通过它的出站数据包中出现的源地址。这就防止了内部网络实际地址的细节被泄露给外人，否则，他们可能使用地址扫描实用程序精确的了解任意给定范围内的在用地址。反过来，这些信息让外部人能够确定在用的子网掩码是什么以及内部网络是如何布局的。通过封锁这些信息，机智的网络管理员可以限制非法进入或其他攻击。

